name: CICD Test
run-name: Running
on:
  push:
    branches:
      - master

env:
  AWS_REGION: eu-north-1
  AWS_S3_BUCKET: gugumo-s3
  AWS_CODE_DEPLOY_APPLICATION: gugumo-cicd-test
  AWS_CODE_DEPLOY_GROUP: gugumo-cicd-test-group

jobs:
  build-with-gradle:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout master branch
      uses: actions/checkout@v3
      with:
        token: ${{secrets.GUGUMO_PROPERTIES}}
        submodules: true
        ref: master
          
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'
          
    - name: gradlew 실행 권한 부여
      run: chmod +x ./gradlew
        
    - name: 프로젝트 빌드(테스트 코드 제외)
      run: |
        ./gradlew copyGitSubmodule
        ./gradlew copyFirebaseKeyFromGitSubmodule
        ./gradlew clean build --exclude-task test

    - name: docker build and push
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker build -t ${{ secrets.DOCKER_USERNAME}/gugumo-test .
        docker push ${{ secrets.DOCKER_USERNAME}/gugumo-test:latest
        

    - name: Deploy to ec2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_TEST }} # EC2 퍼블릭 IPv4 DNS
        username: ubuntu
        key: ${{ secrets.PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          sudo docker ps
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/docker-test-prod
          sudo docker run -d -p 8080:8080 ${{ secrets.DOCKER_USERNAME }}/gugumo-test
          sudo docker image prune -f
        # 도커에서 사용하지 않는 리소스 삭제
